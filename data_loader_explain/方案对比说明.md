# æ–¹æ¡ˆä¸€ vs æ–¹æ¡ˆäºŒï¼šè¯¦ç»†å¯¹æ¯”è¯´æ˜

## ğŸ” å…³èŠ‚ä½ç½®å·®å€¼ u çš„å®ç°å¯¹æ¯”

### æ–¹æ¡ˆä¸€ï¼šé¢„å…ˆè®¡ç®—å¹¶ä¿å­˜

```python
# åœ¨convert_njf_to_4dgs.pyä¸­
def generate_4dgs_transforms(frames, cameras, ...):
    # æ’åº
    train_frames_sorted = sorted(train_frames, key=lambda x: (x['time'], x.get('camera_idx', 0)))
    
    # ä¸ºæ¯ä¸ªç›¸æœºç»´æŠ¤prev_joint_pos
    prev_joint_pos_per_camera = {}
    
    for frame in train_frames_sorted:
        camera_idx = frame.get('camera_idx', 0)
        prev_joint_pos = prev_joint_pos_per_camera.get(camera_idx, None)
        
        # åˆå¹¶å¹¶è®¡ç®—u
        merged_frame = merge_camera_and_frame(frame, cameras, coord_transform, prev_joint_pos)
        
        # æ›´æ–°prev_joint_pos
        if 'joint_pos' in frame:
            prev_joint_pos_per_camera[camera_idx] = np.array(frame['joint_pos'])
    
    # ä¿å­˜åˆ°JSON
    json.dump(output_data, f, indent=4)
```

**ä¼˜åŠ¿**ï¼š
- âœ… uå·²ç»è®¡ç®—å¥½ï¼ŒåŠ è½½å¿«é€Ÿ
- âœ… å¯ä»¥ç›´æ¥æŸ¥çœ‹å’ŒéªŒè¯uå€¼
- âœ… è°ƒè¯•æ–¹ä¾¿

### æ–¹æ¡ˆäºŒï¼šè¿è¡Œæ—¶åŠ¨æ€è®¡ç®—

```python
# åœ¨scene/njf_toyarm_loader.pyä¸­
def readNJFTransforms(path, ...):
    # æ’åº
    frames_sorted = sorted(frames, key=lambda x: (x['time'], x.get('camera_idx', 0)))
    
    # ä¸ºæ¯ä¸ªç›¸æœºç»´æŠ¤prev_joint_pos
    prev_joint_pos_per_camera = {}
    
    for frame in frames_sorted:
        camera_idx = frame['camera_idx']
        curr_joint_pos = np.array(frame['joint_pos'])
        prev_joint_pos = prev_joint_pos_per_camera.get(camera_idx, None)
        
        # è®¡ç®—u
        if prev_joint_pos is not None:
            u = curr_joint_pos - prev_joint_pos
        else:
            u = np.zeros_like(curr_joint_pos)
        
        # åˆ›å»ºCameraInfoWithUå¯¹è±¡
        cam_info = CameraInfoWithU(..., u=u, joint_pos=curr_joint_pos)
        
        # æ›´æ–°prev_joint_pos
        prev_joint_pos_per_camera[camera_idx] = curr_joint_pos
```

**ä¼˜åŠ¿**ï¼š
- âœ… ä¸éœ€è¦é¢å¤–å­˜å‚¨ç©ºé—´
- âœ… ç›´æ¥ä»åŸå§‹æ•°æ®è®¡ç®—
- âœ… ä¾¿äºä¿®æ”¹è®¡ç®—é€»è¾‘

### uçš„éªŒè¯

**æ–¹æ¡ˆä¸€**ï¼šæ£€æŸ¥JSONæ–‡ä»¶
```python
import json
data = json.load(open('data/toyarm_converted/transforms_train.json'))
print('First frame u:', data['frames'][0]['u'])  # åº”è¯¥æ˜¯[0,0,0,0,0,0]
```

**æ–¹æ¡ˆäºŒ**ï¼šæ£€æŸ¥CameraInfoå¯¹è±¡
```python
from scene.njf_toyarm_loader import readNJFSceneInfo
scene_info = readNJFSceneInfo('/path/to/data', False, True)
cam_info = scene_info.train_cameras[0]
print('First camera u:', cam_info.u)  # åº”è¯¥æ˜¯[0,0,0,0,0,0]
```

---

### æ–¹æ¡ˆä¸€ï¼šæ•°æ®è½¬æ¢æ–¹æ¡ˆ
**æœ¬è´¨**ï¼šåˆ›å»ºä¸€ä¸ª**æ–°çš„æ•°æ®ç›®å½•**ï¼Œé‡Œé¢æœ‰è½¬æ¢åçš„æ–‡ä»¶

### æ–¹æ¡ˆäºŒï¼šä»£ç ä¿®æ”¹æ–¹æ¡ˆ
**æœ¬è´¨**ï¼šä¿®æ”¹4DGaussiansä»£ç ï¼Œè®©å®ƒèƒ½**ç›´æ¥è¯»å–åŸå§‹NJFæ•°æ®**

---

## ğŸ“‹ æ–¹æ¡ˆä¸€ï¼šæ•°æ®è½¬æ¢ï¼ˆæ¨èï¼‰

### â“ éœ€è¦ç”Ÿæˆæ–°çš„transforms.jsonå—ï¼Ÿ
**ç­”ï¼šæ˜¯çš„**ï¼Œä½†æ˜¯ç”Ÿæˆåˆ°**æ–°çš„ç›®å½•**ï¼Œ**ä¸æ›¿æ¢**åŸå§‹æ–‡ä»¶ï¼

### ğŸ“ ç›®å½•ç»“æ„è¯´æ˜

**ä½ çš„åŸå§‹NJFæ•°æ®**ï¼ˆä¿æŒä¸å˜ï¼‰ï¼š
```
d:\Codee\neural-jacobian-field\data\toyarm\
â”œâ”€â”€ transforms.json           # åŸå§‹NJFæ ¼å¼ï¼ˆä¿æŒä¸å˜ï¼ï¼‰
â”œâ”€â”€ view_0/
â”‚   â””â”€â”€ rgb/
â”‚       â”œâ”€â”€ 01022_00000.png
â”‚       â””â”€â”€ ...
â”œâ”€â”€ view_1/
â””â”€â”€ ...
```

**è½¬æ¢åç”Ÿæˆçš„æ–°ç›®å½•**ï¼š
```
d:\Codee\4DGaussians\data\toyarm_converted\    # æ–°å»ºç›®å½•
â”œâ”€â”€ transforms_train.json    # æ–°ç”Ÿæˆï¼š4DGaussiansæ ¼å¼çš„è®­ç»ƒé›†
â”œâ”€â”€ transforms_test.json     # æ–°ç”Ÿæˆï¼š4DGaussiansæ ¼å¼çš„æµ‹è¯•é›†
â””â”€â”€ fused.ply               # æ–°ç”Ÿæˆï¼šåˆå§‹ç‚¹äº‘
```

### âœ… ä½¿ç”¨æ­¥éª¤

```bash
# æ­¥éª¤1ï¼šè½¬æ¢æ•°æ®ï¼ˆç”Ÿæˆåˆ°æ–°ç›®å½•ï¼‰
python convert_njf_to_4dgs.py \
    --input d:\Codee\neural-jacobian-field\data\toyarm\transforms.json \
    --output d:\Codee\4DGaussians\data\toyarm_converted

# æ­¥éª¤2ï¼šè®­ç»ƒæ—¶æŒ‡å‘æ–°ç›®å½•
python train.py \
    -s d:\Codee\4DGaussians\data\toyarm_converted \
    -m d:\Codee\4DGaussians\output\toyarm \
    --eval
```

### ğŸ“¸ å›¾åƒæ–‡ä»¶å¤„ç†

æœ‰ä¸¤ç§æ–¹å¼å¤„ç†å›¾åƒï¼š

#### æ–¹å¼Aï¼šä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ˆé»˜è®¤ï¼Œæ¨èï¼‰

è½¬æ¢è„šæœ¬ç”Ÿæˆçš„ `transforms_train.json` ä¸­ä¿æŒåŸå§‹è·¯å¾„ï¼š
```json
{
    "frames": [
        {
            "file_path": "view_0/rgb/01022_00000.png",  // ç›¸å¯¹è·¯å¾„
            ...
        }
    ]
}
```

**ä½†æ˜¯å›¾åƒæ–‡ä»¶è¿˜åœ¨åŸå§‹NJFç›®å½•ï¼**

è§£å†³æ–¹æ³•ï¼š**åˆ›å»ºç¬¦å·é“¾æ¥**

```powershell
# Windows PowerShellï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰
cd d:\Codee\4DGaussians\data\toyarm_converted

# ä¸ºæ¯ä¸ªviewç›®å½•åˆ›å»ºç¬¦å·é“¾æ¥
for ($i=0; $i -lt 12; $i++) {
    New-Item -ItemType SymbolicLink -Path "view_$i" -Target "d:\Codee\neural-jacobian-field\data\toyarm\view_$i"
}
```

æˆ–è€…ï¼ˆä¸éœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰ï¼š
```powershell
# åˆ›å»ºç›®å½•è¿æ¥ï¼ˆJunctionï¼‰
for ($i=0; $i -lt 12; $i++) {
    cmd /c mklink /J "view_$i" "d:\Codee\neural-jacobian-field\data\toyarm\view_$i"
}
```

**ç»“æœ**ï¼š
```
d:\Codee\4DGaussians\data\toyarm_converted\
â”œâ”€â”€ transforms_train.json
â”œâ”€â”€ transforms_test.json
â”œâ”€â”€ fused.ply
â”œâ”€â”€ view_0 -> d:\Codee\neural-jacobian-field\data\toyarm\view_0  # ç¬¦å·é“¾æ¥
â”œâ”€â”€ view_1 -> d:\Codee\neural-jacobian-field\data\toyarm\view_1
â””â”€â”€ ...
```

#### æ–¹å¼Bï¼šå¤åˆ¶å›¾åƒï¼ˆç®€å•ä½†å ç©ºé—´ï¼‰

```bash
# ä½¿ç”¨ --copy_images å‚æ•°
python convert_njf_to_4dgs.py \
    --input d:\Codee\neural-jacobian-field\data\toyarm\transforms.json \
    --output d:\Codee\4DGaussians\data\toyarm_converted \
    --copy_images
```

è¿™ä¼šæŠŠæ‰€æœ‰å›¾åƒå¤åˆ¶åˆ°æ–°ç›®å½•ï¼Œå ç”¨æ›´å¤šç©ºé—´ä½†æ›´ç®€å•ã€‚

### âœ… æ–¹æ¡ˆä¸€æ€»ç»“

- âœ… **ä¸ä¿®æ”¹**åŸå§‹NJFæ•°æ®
- âœ… **ä¸æ›¿æ¢**åŸå§‹transforms.json
- âœ… åˆ›å»º**æ–°ç›®å½•**å­˜æ”¾è½¬æ¢åçš„æ–‡ä»¶
- âœ… å›¾åƒå¯ä»¥é€šè¿‡ç¬¦å·é“¾æ¥å…±äº«ï¼ˆä¸é‡å¤å ç”¨ç©ºé—´ï¼‰
- âœ… åŸå§‹æ•°æ®å’Œè½¬æ¢æ•°æ®å®Œå…¨ç‹¬ç«‹

---

## ğŸ“‹ æ–¹æ¡ˆäºŒï¼šä»£ç ä¿®æ”¹

### â“ éœ€è¦ç”Ÿæˆæ–°çš„transforms.jsonå—ï¼Ÿ
**ç­”ï¼šä¸éœ€è¦ï¼** æ–¹æ¡ˆäºŒå°±æ˜¯ä¸ºäº†ç›´æ¥è¯»å–åŸå§‹NJFæ ¼å¼çš„transforms.json

### â“ éœ€è¦ä¿®æ”¹åŸå§‹æ•°æ®æ–‡ä»¶å¤¹ç»“æ„å—ï¼Ÿ
**ç­”ï¼šå®Œå…¨ä¸éœ€è¦ï¼** ä¿æŒåŸå§‹NJFæ•°æ®ç»“æ„ä¸å˜

### ğŸ“ ç›®å½•ç»“æ„ï¼ˆä¿æŒä¸å˜ï¼‰

```
d:\Codee\neural-jacobian-field\data\toyarm\
â”œâ”€â”€ transforms.json           # ä¿æŒåŸå§‹NJFæ ¼å¼ï¼Œä¸ä¿®æ”¹ï¼
â”œâ”€â”€ view_0/
â”‚   â”œâ”€â”€ rgb/
â”‚   â”‚   â”œâ”€â”€ 01022_00000.png
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ depth/
â”‚       â””â”€â”€ ...
â”œâ”€â”€ view_1/
â””â”€â”€ ...
```

### âœ… ä½¿ç”¨æ­¥éª¤

```bash
# æ­¥éª¤1ï¼šå°†loaderæ–‡ä»¶å¤åˆ¶åˆ°sceneç›®å½•
# ï¼ˆå·²åˆ›å»ºï¼šscene/njf_toyarm_loader.pyï¼‰

# æ­¥éª¤2ï¼šä¿®æ”¹4DGaussiansä»£ç ï¼ˆè§ä¸‹æ–¹ï¼‰

# æ­¥éª¤3ï¼šç›´æ¥è®­ç»ƒåŸå§‹NJFæ•°æ®
python train.py \
    -s d:\Codee\neural-jacobian-field\data\toyarm \
    --dataset_type NJF \
    -m d:\Codee\4DGaussians\output\toyarm \
    --eval
```

### ğŸ”§ éœ€è¦ä¿®æ”¹çš„ä»£ç 

#### ä¿®æ”¹1ï¼šscene/dataset_readers.py

åœ¨æ–‡ä»¶å¼€å¤´æ·»åŠ å¯¼å…¥ï¼ˆçº¦ç¬¬30è¡Œé™„è¿‘ï¼‰ï¼š
```python
from scene.gaussian_model import BasicPointCloud
from utils.general_utils import PILtoTorch
from tqdm import tqdm
from scene.njf_toyarm_loader import readNJFSceneInfo  # æ·»åŠ è¿™ä¸€è¡Œ
```

åœ¨æ–‡ä»¶æœ«å°¾ä¿®æ”¹å­—å…¸ï¼ˆçº¦ç¬¬679è¡Œï¼‰ï¼š
```python
sceneLoadTypeCallbacks = {
    "Colmap": readColmapSceneInfo,
    "Blender" : readNerfSyntheticInfo,
    "dynerf" : readdynerfInfo,
    "nerfies": readHyperDataInfos,
    "PanopticSports" : readPanopticSportsinfos,
    "MultipleView": readMultipleViewinfos,
    "NJF": readNJFSceneInfo,  # æ·»åŠ è¿™ä¸€è¡Œ
}
```

### âœ… æ–¹æ¡ˆäºŒæ€»ç»“

- âœ… **ä¸ç”Ÿæˆ**æ–°çš„transforms.json
- âœ… **ä¸ä¿®æ”¹**åŸå§‹æ•°æ®ç»“æ„
- âœ… **ç›´æ¥è¯»å–**åŸå§‹NJFæ ¼å¼
- âœ… éœ€è¦ä¿®æ”¹4DGaussiansä»£ç 
- âœ… é€‚åˆé¢‘ç¹ä½¿ç”¨NJFæ•°æ®çš„åœºæ™¯

---

## ğŸ“Š æ–¹æ¡ˆå¯¹æ¯”è¡¨

| å¯¹æ¯”é¡¹ | æ–¹æ¡ˆä¸€ï¼šæ•°æ®è½¬æ¢ | æ–¹æ¡ˆäºŒï¼šä»£ç ä¿®æ”¹ |
|-------|----------------|----------------|
| **ç”Ÿæˆæ–°transforms.json** | âœ… æ˜¯ï¼ˆç”Ÿæˆåˆ°æ–°ç›®å½•ï¼‰ | âŒ å¦ |
| **æ›¿æ¢åŸå§‹transforms.json** | âŒ å¦ | âŒ å¦ |
| **ä¿®æ”¹åŸå§‹æ•°æ®ç»“æ„** | âŒ å¦ | âŒ å¦ |
| **ä¿®æ”¹4DGaussiansä»£ç ** | âŒ å¦ | âœ… æ˜¯ |
| **å›¾åƒæ–‡ä»¶ä½ç½®** | å¯ç”¨ç¬¦å·é“¾æ¥æˆ–å¤åˆ¶ | ä¿æŒåŸä½ |
| **æ•°æ®ç‹¬ç«‹æ€§** | å®Œå…¨ç‹¬ç«‹ | å…±äº«åŸå§‹æ•°æ® |
| **å ç”¨ç©ºé—´** | å°ï¼ˆç¬¦å·é“¾æ¥ï¼‰æˆ–å¤§ï¼ˆå¤åˆ¶ï¼‰ | å‡ ä¹æ— é¢å¤–ç©ºé—´ |
| **é€‚ç”¨åœºæ™¯** | ä¸€æ¬¡æ€§æµ‹è¯•ã€å¿«é€ŸéªŒè¯ | é¢‘ç¹ä½¿ç”¨ã€è‡ªå®šä¹‰å¼€å‘ |

---

## ğŸ¯ æ¨èä½¿ç”¨æµç¨‹

### åˆæ¬¡ä½¿ç”¨ï¼šæ–¹æ¡ˆä¸€

```bash
# 1. è½¬æ¢æ•°æ®åˆ°æ–°ç›®å½•
python convert_njf_to_4dgs.py \
    --input d:\Codee\neural-jacobian-field\data\toyarm\transforms.json \
    --output d:\Codee\4DGaussians\data\toyarm_test

# 2. åˆ›å»ºç¬¦å·é“¾æ¥ï¼ˆé¿å…å¤åˆ¶å›¾åƒï¼‰
cd d:\Codee\4DGaussians\data\toyarm_test
for ($i=0; $i -lt 12; $i++) {
    cmd /c mklink /J "view_$i" "d:\Codee\neural-jacobian-field\data\toyarm\view_$i"
}

# 3. è®­ç»ƒ
python train.py -s d:\Codee\4DGaussians\data\toyarm_test -m output\test --eval

# 4. å¦‚æœæˆåŠŸï¼Œå¯ä»¥è€ƒè™‘æ–¹æ¡ˆäºŒï¼ˆå¯é€‰ï¼‰
```

### å¦‚æœéœ€è¦é¢‘ç¹ä½¿ç”¨ï¼šæ–¹æ¡ˆäºŒ

åªæœ‰å½“ä½ ç¡®è®¤æ–¹æ¡ˆä¸€å·¥ä½œæ­£å¸¸ï¼Œä¸”éœ€è¦é¢‘ç¹ä½¿ç”¨NJFæ•°æ®æ—¶ï¼Œå†è€ƒè™‘å®æ–½æ–¹æ¡ˆäºŒã€‚

---

## â“ å¸¸è§é—®é¢˜

### Q1: æ–¹æ¡ˆä¸€ï¼Œæˆ‘èƒ½ç›´æ¥æ›¿æ¢åŸå§‹transforms.jsonå—ï¼Ÿ

**ä¸å»ºè®®ï¼** å› ä¸ºï¼š
1. æ ¼å¼ä¸åŒï¼šNJFæ ¼å¼æœ‰`cameras`æ•°ç»„ï¼Œ4DGaussiansæ ¼å¼æ²¡æœ‰
2. å¦‚æœæ›¿æ¢ï¼ŒNJFé¡¹ç›®å¯èƒ½æ— æ³•ä½¿ç”¨
3. å¤‡ä»½å¾ˆé‡è¦

å¦‚æœä¸€å®šè¦æ›¿æ¢ï¼š
```bash
# å…ˆå¤‡ä»½
cp d:\Codee\neural-jacobian-field\data\toyarm\transforms.json transforms.json.backup

# ç„¶åè½¬æ¢
python convert_njf_to_4dgs.py --input ... --output d:\Codee\neural-jacobian-field\data\toyarm
```

ä½†è¿™æ ·ä¼šç ´åNJFæ•°æ®ç»“æ„ï¼Œ**å¼ºçƒˆä¸æ¨è**ï¼

### Q2: æ–¹æ¡ˆä¸€ï¼Œç¬¦å·é“¾æ¥åˆ›å»ºå¤±è´¥æ€ä¹ˆåŠï¼Ÿ

ä½¿ç”¨ `--copy_images` å‚æ•°ï¼š
```bash
python convert_njf_to_4dgs.py \
    --input d:\Codee\neural-jacobian-field\data\toyarm\transforms.json \
    --output d:\Codee\4DGaussians\data\toyarm_converted \
    --copy_images
```

ç¼ºç‚¹ï¼šä¼šå ç”¨é¢å¤–ç©ºé—´ï¼ˆå¤§çº¦å‡ GBï¼‰

### Q3: æ–¹æ¡ˆäºŒï¼Œå¦‚ä½•éªŒè¯ä»£ç ä¿®æ”¹æ­£ç¡®ï¼Ÿ

```python
# æµ‹è¯•å¯¼å…¥
cd d:\Codee\4DGaussians
python -c "from scene.njf_toyarm_loader import readNJFSceneInfo; print('Import OK')"

# æµ‹è¯•åŠ è½½
python -c "
from scene.njf_toyarm_loader import readNJFSceneInfo
scene = readNJFSceneInfo('d:/Codee/neural-jacobian-field/data/toyarm', False, True)
print(f'Train cameras: {len(scene.train_cameras)}')
print(f'Test cameras: {len(scene.test_cameras)}')
"
```

### Q4: ä¸¤ä¸ªæ–¹æ¡ˆå¯ä»¥åŒæ—¶ä½¿ç”¨å—ï¼Ÿ

å¯ä»¥ï¼å®ƒä»¬å®Œå…¨ç‹¬ç«‹ï¼š
- æ–¹æ¡ˆä¸€çš„è½¬æ¢æ•°æ®åœ¨ `4DGaussians/data/toyarm_converted/`
- æ–¹æ¡ˆäºŒç›´æ¥è¯»å–åŸå§‹æ•°æ®åœ¨ `neural-jacobian-field/data/toyarm/`

---

## ğŸ“ å¿«é€Ÿå‚è€ƒ

### æ–¹æ¡ˆä¸€å‘½ä»¤ï¼ˆå®Œæ•´ç‰ˆï¼‰

```powershell
# 1. è½¬æ¢
python convert_njf_to_4dgs.py `
    --input "d:\Codee\neural-jacobian-field\data\toyarm\transforms.json" `
    --output "d:\Codee\4DGaussians\data\toyarm_converted"

# 2. åˆ›å»ºç¬¦å·é“¾æ¥
cd "d:\Codee\4DGaussians\data\toyarm_converted"
0..11 | ForEach-Object { cmd /c mklink /J "view_$_" "d:\Codee\neural-jacobian-field\data\toyarm\view_$_" }

# 3. è®­ç»ƒ
cd "d:\Codee\4DGaussians"
python train.py -s "data\toyarm_converted" -m "output\toyarm" --eval
```

### æ–¹æ¡ˆäºŒå‘½ä»¤ï¼ˆå®Œæ•´ç‰ˆï¼‰

```powershell
# 1. ç¡®è®¤loaderæ–‡ä»¶å­˜åœ¨
Test-Path "d:\Codee\4DGaussians\scene\njf_toyarm_loader.py"

# 2. ä¿®æ”¹dataset_readers.pyï¼ˆæ‰‹åŠ¨ç¼–è¾‘ï¼‰

# 3. è®­ç»ƒ
cd "d:\Codee\4DGaussians"
python train.py -s "d:\Codee\neural-jacobian-field\data\toyarm" --dataset_type NJF -m "output\toyarm" --eval
```

---

**æ€»ç»“**ï¼š
- âœ… æ–¹æ¡ˆä¸€ï¼šç”Ÿæˆåˆ°æ–°ç›®å½•ï¼Œä¸æ›¿æ¢åŸæ–‡ä»¶
- âœ… æ–¹æ¡ˆäºŒï¼šç›´æ¥è¯»å–åŸæ–‡ä»¶ï¼Œä¸ç”Ÿæˆæ–°æ–‡ä»¶
- âœ… ä¸¤ç§æ–¹æ¡ˆéƒ½ä¸ä¼šç ´ååŸå§‹NJFæ•°æ®ç»“æ„
